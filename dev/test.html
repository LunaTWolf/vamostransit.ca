<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paddle Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Dropdown Container */
        .dropdown-container {
            border: 1px solid #ccc;
            border-radius: 4px;
            max-width: 100%;
            padding: 5px;
            font-family: Arial, sans-serif;
        }

        /* Dropdown Item */
        .dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            user-select: none;
        }

        .dropdown-item:hover {
            background-color: #f0f0f0;
        }

        /* Selected Item */
        .dropdown-item.selected {
            background-color: #007bff;
            color: white;
        }

        .option-left {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 10px;
        }

        .option-right {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .option-title {
            font-weight: bold;
        }

        .option-runtime {
            font-size: 0.9em;
            color: lightgray;
        }

        .option-order {
            margin-left: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Schedule Generator</h1>
        <form method="GET" action="tablet.php">
            <div class="mb-3">
                <label for="block" class="form-label">Block #</label>
                <input type="text" class="form-control" id="block" name="block">
            </div>
            <div class="mb-3">
                <label for="driver" class="form-label">Driver #</label>
                <input type="text" class="form-control" id="driver" name="driver">
            </div>
            <div class="mb-3">
                <label for="initialStartTime" class="form-label">Initial Start Time (24-hour HH:MM)</label>
                <input type="time" class="form-control" id="initialStartTime" name="initialStartTime">
            </div>
            <div class="mb-3">
                <label for="patternids" class="form-label">
                    <a href="https://docs.google.com/document/d/1w9LADWKKLGdQQpBDr56cmNX7QvB4l8uJa6sb_585qSE/edit?usp=sharing">BRILLIANT Pattern IDs separated by commas</a>
                </label>
                <!-- Custom Multi-Select Dropdown -->
                <div id="dropdown" class="dropdown-container">
                    <!-- Items will be dynamically added here -->
                </div>
                <!-- Hidden Input to hold the text value -->
                <input type="hidden" id="patternids" name="patternids" value="">
            </div>
            <div class="mb-3">
                <label for="starttimes" class="form-label">For each pattern, First Stop Departure Time in 24hour HH:MM format, separated by commas</label>
                <input type="text" class="form-control" id="starttimes" name="starttimes" readonly>
            </div>
            <button type="submit" class="btn btn-primary">Generate</button>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
    const dropdown = document.getElementById("dropdown");
    const hiddenInput = document.getElementById("patternids");
    const startTimesInput = document.getElementById("starttimes");
    const initialStartTimeInput = document.getElementById("initialStartTime");

    // Predefined options with runtime (converted to HH:MM format)
    const options = [
        { id: "0-depot-cale", name: "Deadhead from Caledonia Depot to Caledonia Term", runtime: "00:04" },
        { id: "0-cale-depot", name: "Deadhead from Caledonia Term to Caledonia Depot", runtime: "00:04" },
        { id: "1hwypr", name: "Caledonia Term to HWY 417 P&R", runtime: "00:13" },
        { id: "1cale", name: "HWY 417 P&R to Caledonia Term", runtime: "00:12" }
    ];

    const selectedItems = [];

    options.forEach((option) => {
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.dataset.value = option.id;

        item.innerHTML = `
            <div class="option-left">${option.id.charAt(0)}</div>
            <div class="option-right">
                <div class="option-title">${option.name}</div>
                <div class="option-runtime">Total run time: ${formatRuntime(option.runtime)}</div>
            </div>
            <div class="option-order"></div>
        `;

        const orderDisplay = item.querySelector(".option-order");

        item.addEventListener("click", function () {
            const index = selectedItems.indexOf(option.id);

            if (index > -1) {
                selectedItems.splice(index, 1);
                item.classList.remove("selected");
            } else {
                selectedItems.push(option.id);
                item.classList.add("selected");
            }

            updateSelection();
        });

        dropdown.appendChild(item);

        function updateSelection() {
            const allItems = document.querySelectorAll(".dropdown-item");
            allItems.forEach((el) => {
                const value = el.dataset.value;
                const order = selectedItems.indexOf(value);
                const orderDisplay = el.querySelector(".option-order");
                if (order > -1) {
                    orderDisplay.textContent = `${order + 1}${getOrdinalSuffix(order + 1)}: ${calculateDepartureTime(order)}`;
                } else {
                    orderDisplay.textContent = "";
                }
            });

            hiddenInput.value = selectedItems.join(", ");
            updateStartTimes();
        }

        function getOrdinalSuffix(n) {
            const j = n % 10, k = n % 100;
            if (j === 1 && k !== 11) return "st";
            if (j === 2 && k !== 12) return "nd";
            if (j === 3 && k !== 13) return "rd";
            return "th";
        }

        function calculateDepartureTime(order) {
            const initialTime = initialStartTimeInput.value;
            if (!initialTime) return '';

            let [hour, minute] = initialTime.split(":").map(Number);

            if (order === 0) {
                return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            } else {
                const previousPattern = options.find(opt => opt.id === selectedItems[order - 1]);
                const runtimeMinutes = parseRuntime(previousPattern.runtime);

                minute += runtimeMinutes + 1;
                while (minute >= 60) {
                    minute -= 60;
                    hour += 1;
                }

                return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            }
        }

        function parseRuntime(runtime) {
            const [hh, mm] = runtime.split(":").map(Number);
            return hh * 60 + mm; // Convert HH:MM to total minutes
        }

        function formatRuntime(runtime) {
            // Format all runtimes to "HH:MM" format
            const [mm] = runtime.split(":").map(Number);
            const hours = Math.floor(mm / 60);
            const minutes = mm % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        function updateStartTimes() {
            const departureTimes = selectedItems.map((itemId, index) => {
                return calculateDepartureTime(index);
            });

            startTimesInput.value = departureTimes.join(", ");
        }
    });
});
    </script>    
</body>
</html>
